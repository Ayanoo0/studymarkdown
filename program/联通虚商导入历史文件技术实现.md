# 联通虚商导入历史文件技术实现

> 文档类型：设计文档  
> 中文名称：电信库存管理系统  
> 英文名称：huahong erp system  
> 英文简称：HERP  
> 文档维护：陈灿  
> 电子邮件：chencan@bhz.com.cn  
> 控制范围：产品组、开发组  
> 文件版本：V0.02

## 1. 制卡列表数据

### 1.1. 定义

- //TODO;
- 制卡文件里面的iccid是正序的19位；
- 卡商mca文件中的iccid是高低位转换过的20位（卡商会在正序19位后添加一位（0-9）后高低位转换得20位）；

### 1.2. 状态说明

- new，初始状态；
- disable，无效状态；
- imported，已导入；

## 2. 通用过程

### 2.1. 保存制卡列表数据

#### 2.1.1. 查询已存在的制卡列表数据

- 使用制卡申请单号，查询已存在的、状态不是 disable 的制卡列表数据；

#### 2.1.2. 解压制卡文件

- 若文件不存在，则记录错误信息，制卡文件不存在；
- 解压制卡文件到压缩包所在文件夹下的制卡申请单号文件夹，例如`~/volumns/cardapplyresp/418/cu/ZS4180200001/`；

#### 2.1.3. 保存制卡列表数据

- 保存制卡列表数据，若数据已存在，则跳过；
- 状态为 new；
- 更新制卡申请单进度为 100.00%；
- 单行制卡列表数据包含了一个省份地市的总制卡量、iccid 的起止和制卡明细文件的起止，需要将单行信息根据规范，拆分成多行 mca 列表信息，具体规范参考联通规范，例如：

制卡列表数据：
| 省份 | 地市 | 总制卡量 | 起始 iccid          | 结束 iccid          | 起始文件名                 | 结束文件名                 |
| ---- | ---- | -------- | ------------------- | ------------------- | -------------------------- | -------------------------- |
| 北京 | 北京 | 10000    | 8986011984187382177 | 8986011984187392176 | ZS4180190082_A037_0001.txt | ZS4180190082_A037_0002.txt |

转换为 mca 列表数据：
| 省份 | 地市 | 总制卡量 | 起始 iccid          | 结束 iccid          | mca 文件名             |
| ---- | ---- | -------- | ------------------- | ------------------- | ---------------------- |
| 北京 | 北京 | 5000     | 8986011984187382177 | 8986011984187387176 | ZS4180190082_A037_0001 |
| 北京 | 北京 | 5000     | 8986011984187387177 | 8986011984187392176 | ZS4180190082_A037_0002 |

- 若 iccid 的本年的制卡量超过 1 千万，则需要在年份加上 50，例如 8986011984187382177 溢出后的格式为 898601`69`84187382177；
- 单行 mca 的总制卡量不超过 5000；

### 2.2. 保存 mca 数据

#### 2.2.1. 清理数据

- 清理 imsi 分表数据；
- 清理 mca 分表数据；

#### 2.2.2. 导入 imsi 分表

- 白卡的 imsi 为全 F，故不需要进行唯一性校验，无限导入 imsi 分表；

##### 2.2.2.1. 定位分表

- imsi 分表规则：`imsi_` + `基础运营商代码` + `_` + `省份代码` + `_` + `虚商代码`，例如`imsi_cu_17_418`；
- 根据基础运营商代码、省份代码、虚商代码，查询分表是否存在，若不存在则创建表；

##### 2.2.2.2. 导入数据

- 将 imsi 导入 imsi 分表；
- 若违反 imsi 唯一性约束，则停止导入，并记录错误，存在 imsi 重复；

#### 2.2.3. 导入 mca 分表

##### 2.2.3.1. 定位分表

- mca 分表规则：`mca_` + `基础运营商代码` + `_` + `年份` + `_` + `虚商代码`，例如`mca_cu_20_418`；
- 根据基础运营商代码、年份、虚商代码，查询分表是否存在，若不存在则创建表；

##### 2.2.3.2. 导入数据

- 将 mca 数据导入 mca 分表；
- 若违反 iccid 唯一性约束，则停止导入，并记录错误，存在 iccid 重复；

#### 2.2.4. 更新 mca 列表状态

- 更新 mca 列表状态为`imported`；

## 3. 解密pgp文件

## 4. 解压解密后的zip文件

## 5. 导入制卡文件

### 5.1. 参数校验

- 参数非空，file 数组长度是否为 0；
- 若空或者长度为 0，返回参数错误；

### 5.2. 遍历文件

- 循环 file 数组，创建多线程；
- 在各自的线程中，执行文件的解析导入；
- 主线程，直接返回开始导入，请关注导入进度；

### 5.3. 解析文件名

- 解析文件名，获取虚商代码、年份和成白卡类型；
- 若报错，则记录错误信息文件不符合规范；

### 5.4. 保存制卡申请单信息

- 若数据库中不存在制卡申请单号或者状态为无效，则保存制卡申请单号到数据库；
- 将制卡申请单的进度重置为 0.00%；

### 5.5. 获取文件类型信息

- 根据文件类型，获取文件存储目录等信息；
- 文件类型，本接口中的值固定为`cardapplyresp`；

### 5.6. 保存文件到服务器指定目录

- 保存制卡文件到文件类型规定的存储目录；
- 文件类型中的存储目录只规定了制卡文件的根目录，具体路径规划为~/volumns/cardapplyresp/`虚商代码`/`基础运营商代码`/，例如`~/volumns/cardapplyresp/418/cu/`；

### 5.7. 保存文件记录

- 保存文件记录，并配置制卡申请单号；

### 5.8. 保存制卡列表数据

## 6. 导入生产mca文件

### 6.1. 定位生产任务文件夹

- 使用生产任务文件夹名，关联所有生产mca文件；

### 6.2. 参数校验

- 参数非空，file 数组长度是否为 0；
- 若空或者长度为 0，返回参数错误；

### 6.3. 遍历文件

- 循环 file 数组，创建多线程；
- 在各自的线程中，执行文件的解析导入；
- 主线程，直接返回开始导入，请关注导入进度；

### 6.4. 校验文件名

- 若 mca 文件名匹配不到 mca 列表信息中的有效记录，则记录错误，尚未导入 mca 列表信息；
- 若 mca 列表信息显示 mca 文件已完成导入，则跳过；
- 若 mca 列表信息状态为`new`，且上次开始导入的时间在一个小时以内，则阻止导入，并记录错误，mca 文件正在导入；

### 6.5. 获取文件类型信息

- 根据文件类型，获取文件存储目录等信息；
- 文件类型，本接口中的值固定为`cardapplyresp`；

### 6.6. 保存文件到服务器指定目录

- 保存制卡文件到文件类型规定的存储目录；
- 文件类型中的存储目录只规定了制卡文件的根目录，具体路径规划为~/volumns/mca/`虚商代码`/`基础运营商代码`/，例如`~/volumns/mca/418/cu/`；

### 6.7. 保存文件记录

- 保存文件记录，并配置制卡申请单号；

### 6.8. 保存 mca 数据

- 详见通用过程；

## 7. 导入标准mca文件

## 8. 导入禁用的mca明细

## 9. 导入生产任务

### 9.1. 导入生产任务基础信息

### 9.2. 导入mca模板
