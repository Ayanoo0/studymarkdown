# 实施方案

> 文档类型：实施方案  
> 所属系统：海航通信远程写卡系统  
> 英文名称：hna telecom remote personalization system  
> 英文简称：RPS  
> 文档维护：陈灿  
> 电子邮件：chencan@bhz.com.cn  
> 控制范围：产品组、开发组  
> 文件版本：V0.01

## 1. 系统描述

### 1.1. 定义

```txt
    SIM卡是GSM系统的移动用户所持有的IC卡，称为用户识别卡。GSM系统通过SIM卡来识别GSM用户。同一张SIM卡可在不同的手机上使用。GSM手机只有插入SIM卡后，才能入网使用。SIM卡类型主要包含白卡和成卡两种。
    远程写卡系统主要涉及SIM卡的写卡流程、制卡流程和卡资源管理。SIM卡的写卡流程，是指虚拟运营商根据用户选号结果，获取基础运营商提供的写卡资源，并使用特定的写卡工具，将写卡资源写入SIM卡白卡的流程。SIM卡的制卡流程，是指虚拟运营商根据具体实际运营需求，向基础运营商申请制卡，并最终取得由制卡商制造的，符合制卡申请要求的SIM卡以及SIM卡的信息。卡资源管理是指对IMSI和ICCID等卡资源的管理，实时监控余量，并根据设定规则进行预警。
```

### 1.2. 业务分类

- 按基础运营商分类：
  - 联通：
    - 联通白卡写卡；
    - 联通制卡；
    - 联通卡资源管理；
  - 电信：
    - 电信白卡写卡；
    - 电信白卡制卡；

## 2. 系统框架

### 2.1. 系统架构图

- 系统框架图；// TODO 插入图片

### 2.2. 各单元说明

- 上图中的各单元说明如下：

<table>
	<tr>
	    <th>分类</th>
	    <th>单元名称</th>
	    <th>描述</th>  
	</tr >
	<tr >
	    <td rowspan="4">服务端</td>
        <td>远程写卡系统</td>
	    <td>主要包括SIM卡的写卡流程、制卡流程和卡资源管理等功能。</td>
	</tr>
	<tr>
	    <td>联通VOP系统</td>
	    <td>联通VOP系统提供API接口，供虚拟营运商IT系统接入。</td>
	</tr>
	<tr>
	    <td>电信EOP系统</td>
	    <td>电信EOP系统提供API接口，供虚拟营运商IT系统接入。</td>
	</tr>
	<tr>
	    <td>虚商CRM系统</td>
	    <td>虚拟运营商客户关系系统，包含手机号码和用户信息的管理。</td>
	</tr>
	<tr>
	    <td rowspan="5">客户端</td>
	    <td>写卡服务</td>
	    <td>实现读卡器读写卡功能的服务。</td>
	</tr>
	<tr>
	    <td>PC读卡器</td>
	    <td>PC端用于电脑识别、读写智能卡的终端。</td>
	</tr>
	<tr>
	    <td>APP写卡SDK</td>
	    <td>写卡软件开发工具包。</td>
	</tr>
	<tr>
	    <td>智能手机</td>
	    <td>运行APP的载体。</td>
	</tr>
	<tr>
	    <td>客户端适用性</td>
	    <td>支持多卡商多卡种。</td>
	</tr>
</table>

## 3. 部署方案

- 部署架构图；// TODO 插入图片

| IP          | CPU/C | MEM/G | HD/G | OS      | 主机用途                                   | 部署服务                         |
| ----------- | ----- | ----- | ---- | ------- | ------------------------------------------ | -------------------------------- |
| 10.72.90.70 |       |       |      |         | VIP                                        | VIP                              |
| 10.72.90.71 | 1     | 8     | 500  | centos7 | 负载均衡，docker 部署前端项目              | keepalived + haproxy + docker    |
| 10.72.90.72 | 1     | 8     | 500  | centos7 | 负载均衡，docker 部署前端项目              | keepalived + haproxy + docker    |
| 10.72.90.73 | 1     | 4     | 500  | centos7 | 文档服务器                                 | nfs server                       |
| 10.72.90.74 | 1     | 8     | 500  | centos7 | redis 集群节点，后台管理服务，后台业务服务 | redis，base-service，rps-service |
| 10.72.90.75 | 1     | 8     | 500  | centos7 | redis 集群节点，后台管理服务，后台业务服务 | redis，base-service，rps-service |
| 10.72.90.76 | 1     | 8     | 500  | centos7 | redis 集群节点，后台管理服务，后台业务服务 | redis，base-service，rps-service |

## 4. 写卡流程

### 4.1. 写卡服务

#### 4.1.1. PC 客户端写卡服务

- PC 安装客户端写卡服务，浏览器通过调用写卡服务提供的 http 接口，来执行读写卡的操作，解决浏览器的兼容性问题；

#### 4.1.2. 手机 APP 写卡 SDK

- 手机 APP 通过专用的 SDK，对插入卡槽的定制卡进行读写卡的操作；

### 4.2. 联通白卡写卡流程

- 联通白卡写卡时序图；// TODO 插入图片

1. 虚商 CRM 系统调用客户端写卡服务或手机 APP 接口，开始写卡流程；
2. 读卡，判断卡是否合法；
3. 调用远写系统后台服务，获取写卡资源；
4. 将 IMSI 和短信中心写入白卡；
5. 返回写卡结果至虚商 CRM 系统，结束写卡流程；

### 4.3. 电信白卡写卡流程

- 电信白卡写卡时序图；// TODO 插入图片

1. 虚商 CRM 系统调用客户端写卡服务或手机 APP 接口，开始写卡流程；
2. 读卡，判断卡是否合法；
3. 校验写卡组件是否合法；
4. 实时调用电信 EOP 系统接口，获取写卡数据；
5. 将写卡数据写入白卡；
6. 将写卡结果返回至电信 EOP 系统和虚商 CRM 系统，结束写卡流程；

## 5. 制卡流程

### 5.1. 联通制卡流程

- 联通制卡时序图；// TODO 插入图片

1. 业务人员在远写系统中，录入联通成卡或者白卡制卡的申请明细，并提交，开始制卡流程；
2. 远写系统根据卡资源情况，校验本次制卡的申请明细；
3. 远写系统生成制卡申请文件；
4. 远写系统提交制卡申请文件至联通 VOP 系统文件服务器；
5. 远写系统定时或者立即下载和解析，联通 VOP 系统返回的制卡校验文件和制卡文件；
6. 业务人员根据实际需要，将制卡文件进行拆分，然后将拆分结果发送至卡商；
7. 卡商完成制卡任务后，将 POS 文件提交至联通 VOP 系统文件服务器；
8. 联通审核 POS 文件，并发布 POS 校验文件至联通 VOP 系统文件服务器；
9. 远写系统定时或者立即下载和解析，联通 VOP 系统返回的 POS 校验文件和 POS 文件，结束制卡流程；

### 5.2. 电信白卡制卡流程

- 电信白卡制卡时序图；// TODO 插入图片

1. 业务人员在远写系统中，录入电信白卡制卡的申请明细，并导出制卡申请文件，开始制卡流程；
2. 通过邮件，将制卡申请的卡类型和制卡数量，盖红章，并将扫描件发送给电信；
3. 电信将申请结果文件返回给卡商，结束制卡流程；

## 6. 卡资源管理

- 卡资源管理，是指联通卡的资源管理，主要包括 IMSI 和 ICCID 等资源的管理；

### 6.1. IMSI

- IMSI 的管理，主要是 IMSI 资源文件的定时或立即下载和解析；
- IMSI 的监控，主要是对 IMSI 的库存量的监控，并根据用户设定的阈值，进行余量提醒，以便判断是否进行新一批 IMSI 资源的申请；
- IMSI 的统计，可按多种维度展示 IMSI 的使用量，和使用情况的对比分析；

### 6.2. ICCID

- ICCID 的管理，主要是制卡申请过程中，ICCID 的生成、关联 IMSI 和 ICCID 回收等功能管理；
- ICCID 的监控，主要是对 ICCID 对应的成白卡库存量的监控，并根据用户设定的阈值，进行余量提醒，以便判断是否进行新一批制卡申请；
- ICCID 的统计，可按多种维度展示 ICCID 的使用量，和使用情况的对比分析；
